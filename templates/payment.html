{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='payment.css') }}">

<div class="payment-container">
    <div class="payment-header">
        <h1><i class="fas fa-lock"></i> Secure Payment</h1>
        <p class="payment-subtitle">Complete your Premium upgrade with our secure payment system</p>
    </div>
    
    <div class="payment-wrapper">
        <div class="order-summary">
            <h3>Order Summary</h3>
            <div class="summary-item">
                <span>Premium Plan</span>
                <span>$4.99/month</span>
            </div>
            <div class="summary-item">
                <span>Billing Cycle</span>
                <span>Monthly</span>
            </div>
            <div class="summary-item">
                <span>Features</span>
                <span>Unlimited tasks, Advanced analytics, Priority support</span>
            </div>
            <div class="summary-total">
                <span>Total Today</span>
                <span class="total-amount">$4.99</span>
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('process_payment') }}" class="payment-form" id="paymentForm">
            <h3>Payment Details</h3>
            
            <div class="payment-methods">
                <label class="payment-method selected">
                    <input type="radio" name="method" value="card" checked>
                    <i class="fas fa-credit-card"></i>
                    <span>Credit/Debit Card</span>
                </label>
                <label class="payment-method">
                    <input type="radio" name="method" value="paypal">
                    <i class="fab fa-paypal"></i>
                    <span>PayPal</span>
                </label>
                <label class="payment-method">
                    <input type="radio" name="method" value="virtual">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Virtual Account</span>
                </label>
            </div>
            
            <div class="card-form" id="card-form">
                <div class="form-group">
                    <label>Card Number</label>
                    <input type="text" name="card_number" id="cardNumber" 
                           placeholder="1234 5678 9012 3456" 
                           maxlength="19" 
                           required>
                    <div class="card-icons">
                        <i class="fab fa-cc-visa"></i>
                        <i class="fab fa-cc-mastercard"></i>
                        <i class="fab fa-cc-amex"></i>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="text" name="expiry" id="expiryDate" 
                               placeholder="MM/YY" 
                               maxlength="5"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" name="cvv" id="cvvNumber" 
                               placeholder="123" 
                               maxlength="4"
                               required>
                        <span class="cvv-info" title="3-digit code on back of card">
                            <i class="fas fa-question-circle"></i>
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Cardholder Name</label>
                    <input type="text" name="card_name" id="cardName" 
                           placeholder="John Doe" 
                           required>
                </div>
                
                <div class="demo-info">
                    <p><strong>Demo Card:</strong> 4111 1111 1111 1111 | Exp: 12/25 | CVV: 123</p>
                    <small>This is a test card. No real payment will be processed.</small>
                </div>
            </div>
            
            <div class="paypal-form" id="paypal-form" style="display: none;">
                <div class="paypal-info">
                    <i class="fab fa-paypal fa-3x"></i>
                    <p>You will be redirected to PayPal to complete your payment securely.</p>
                </div>
            </div>
            
            <div class="virtual-form" id="virtual-form" style="display: none;">
                <div class="virtual-info">
                    <div class="virtual-bank">
                        <i class="fas fa-university"></i>
                        <strong>Bank Transfer Details</strong>
                    </div>
                    <div class="virtual-details">
                        <div>
                            <span>Bank:</span>
                            <strong>Scholar Bank</strong>
                        </div>
                        <div>
                            <span>Account Number:</span>
                            <strong>1234-5678-9012</strong>
                        </div>
                        <div>
                            <span>Amount:</span>
                            <strong>$4.99</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="payment-footer">
                <div class="security-info">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure 256-bit SSL encryption. Your payment is safe with us.</span>
                </div>
                
                <div class="payment-actions">
                    <a href="{{ url_for('upgrade') }}" class="cancel-btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                    <button type="submit" class="pay-btn" id="submitBtn">
                        <i class="fas fa-lock"></i> Pay $4.99
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <div class="payment-features">
        <div class="feature">
            <i class="fas fa-shield-alt"></i>
            <h4>Secure Payment</h4>
            <p>Bank-level security with 256-bit encryption</p>
        </div>
        <div class="feature">
            <i class="fas fa-sync-alt"></i>
            <h4>30-Day Refund</h4>
            <p>Money-back guarantee, no questions asked</p>
        </div>
        <div class="feature">
            <i class="fas fa-headset"></i>
            <h4>24/7 Support</h4>
            <p>Get help anytime with premium support</p>
        </div>
    </div>
</div>

<script>
// payment.js - Enhanced with better card number handling
document.addEventListener('DOMContentLoaded', function() {
    console.log('Payment page loaded');
    
    // Elements
    const cardNumberInput = document.getElementById('cardNumber');
    const expiryInput = document.getElementById('expiryDate');
    const cvvInput = document.getElementById('cvvNumber');
    const cardNameInput = document.getElementById('cardName');
    const paymentForm = document.getElementById('paymentForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // ===== CARD NUMBER FORMATTING =====
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            
            // Format dengan spasi setiap 4 digit
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            // Update value (max 19 chars: 16 digits + 3 spaces)
            e.target.value = formatted.substring(0, 19);
            
            // Update card type icon
            updateCardType(value);
        });
        
        // Allow paste
        cardNumberInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                let value = this.value.replace(/\D/g, '');
                let formatted = '';
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formatted += ' ';
                    }
                    formatted += value[i];
                }
                this.value = formatted.substring(0, 19);
                updateCardType(value);
            }, 10);
        });
    }
    
    // ===== EXPIRY DATE FORMATTING =====
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                let month = value.substring(0, 2);
                let year = value.substring(2, 4);
                
                // Validate month (01-12)
                if (parseInt(month) > 12) {
                    month = '12';
                }
                if (parseInt(month) < 1) {
                    month = '01';
                }
                if (month.length === 1 && parseInt(month) > 1) {
                    month = '0' + month;
                }
                
                e.target.value = month + (year ? '/' + year : '');
            } else {
                e.target.value = value;
            }
        });
        
        // Auto-add slash
        expiryInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 3 && this.value[2] === '/') {
                this.value = this.value.substring(0, 2);
            }
        });
    }
    
    // ===== CVV INPUT =====
    if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
            // Allow only digits, max 4 (for Amex)
            this.value = this.value.replace(/\D/g, '').substring(0, 4);
        });
    }
    
    // ===== CARD NAME =====
    if (cardNameInput) {
        cardNameInput.addEventListener('input', function(e) {
            // Allow letters and spaces only
            this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
        });
    }
    
    // ===== PAYMENT METHOD SWITCHING =====
    const paymentMethods = document.querySelectorAll('input[name="method"]');
    const cardForm = document.getElementById('card-form');
    const paypalForm = document.getElementById('paypal-form');
    const virtualForm = document.getElementById('virtual-form');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            // Reset all forms
            cardForm.style.display = 'none';
            paypalForm.style.display = 'none';
            virtualForm.style.display = 'none';
            
            // Show selected form
            if (this.value === 'card') {
                cardForm.style.display = 'block';
            } else if (this.value === 'paypal') {
                paypalForm.style.display = 'block';
            } else if (this.value === 'virtual') {
                virtualForm.style.display = 'block';
            }
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(item => {
                item.classList.remove('selected');
            });
            this.closest('.payment-method').classList.add('selected');
        });
    });
    
    // ===== FORM VALIDATION =====
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const originalText = submitBtn.innerHTML;
            
            // Disable button and show loading
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Payment...';
            submitBtn.disabled = true;
            
            // Get selected payment method
            const selectedMethod = document.querySelector('input[name="method"]:checked').value;
            
            // Validate based on method
            let isValid = true;
            let errorMessage = '';
            
            if (selectedMethod === 'card') {
                // Validate card number (remove spaces)
                const cardNumber = cardNumberInput.value.replace(/\s/g, '');
                if (cardNumber.length !== 16) {
                    isValid = false;
                    errorMessage = 'Please enter a valid 16-digit card number';
                    cardNumberInput.style.borderColor = 'var(--notion-red)';
                }
                
                // Validate expiry date
                const expiry = expiryInput.value;
                if (!expiry.match(/^(0[1-9]|1[0-2])\/[0-9]{2}$/)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid expiry date (MM/YY)';
                    expiryInput.style.borderColor = 'var(--notion-red)';
                }
                
                // Validate CVV
                const cvv = cvvInput.value;
                if (cvv.length < 3 || cvv.length > 4) {
                    isValid = false;
                    errorMessage = 'Please enter a valid CVV (3-4 digits)';
                    cvvInput.style.borderColor = 'var(--notion-red)';
                }
                
                // Validate card name
                if (cardNameInput.value.trim().length < 2) {
                    isValid = false;
                    errorMessage = 'Please enter cardholder name';
                    cardNameInput.style.borderColor = 'var(--notion-red)';
                }
            }
            
            if (!isValid) {
                // Show error
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + errorMessage;
                submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.background = 'linear-gradient(135deg, var(--notion-primary), var(--notion-teal))';
                }, 3000);
                
                return;
            }
            
            // Simulate payment processing (2 seconds)
            setTimeout(() => {
                // Submit the form for real
                this.submit();
            }, 2000);
        });
    }
    
    // ===== HELPER FUNCTIONS =====
    function updateCardType(cardNumber) {
        const cardIcons = document.querySelectorAll('.card-icons i');
        
        // Reset all icons
        cardIcons.forEach(icon => {
            icon.style.color = 'var(--notion-text-light)';
            icon.style.opacity = '0.5';
        });
        
        // Detect card type
        let cardType = 'unknown';
        
        if (cardNumber.startsWith('4')) {
            cardType = 'visa';
        } else if (cardNumber.startsWith('5')) {
            cardType = 'mastercard';
        } else if (cardNumber.startsWith('34') || cardNumber.startsWith('37')) {
            cardType = 'amex';
        } else if (cardNumber.startsWith('6')) {
            cardType = 'discover';
        }
        
        // Highlight appropriate icon
        if (cardType === 'visa') {
            document.querySelector('.fa-cc-visa').style.color = 'var(--notion-primary)';
            document.querySelector('.fa-cc-visa').style.opacity = '1';
        } else if (cardType === 'mastercard') {
            document.querySelector('.fa-cc-mastercard').style.color = 'var(--notion-primary)';
            document.querySelector('.fa-cc-mastercard').style.opacity = '1';
        } else if (cardType === 'amex') {
            document.querySelector('.fa-cc-amex').style.color = 'var(--notion-primary)';
            document.querySelector('.fa-cc-amex').style.opacity = '1';
        }
    }
    
    // CVV info tooltip
    const cvvInfo = document.querySelector('.cvv-info');
    if (cvvInfo) {
        cvvInfo.addEventListener('click', function() {
            alert('CVV is the 3-digit security code on the back of your card (4 digits for American Express).');
        });
    }
    
    // Auto-fill demo card for testing
    function autoFillDemoCard() {
        if (!sessionStorage.getItem('demoCardFilled')) {
            cardNumberInput.value = '4111 1111 1111 1111';
            expiryInput.value = '12/25';
            cvvInput.value = '123';
            cardNameInput.value = 'John Doe';
            updateCardType('4111111111111111');
            sessionStorage.setItem('demoCardFilled', 'true');
        }
    }
    
    // Uncomment line below to enable auto-fill
    // autoFillDemoCard();
});
</script>

<style>
/* Additional inline styles for better UX */
#cardNumber, #expiryDate, #cvvNumber, #cardName {
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
}

#cardNumber {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='1' y='4' width='22' height='16' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='1' y1='10' x2='23' y2='10'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 20px;
    padding-right: 3rem;
}

#expiryDate {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 20px;
    padding-right: 3rem;
}

#cvvNumber {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 20px;
    padding-right: 3rem;
}

/* Validation states */
input:valid {
    border-color: var(--notion-green);
}

input:invalid:not(:placeholder-shown) {
    border-color: var(--notion-red);
}

/* Animasi untuk card icons */
.card-icons i {
    transition: all 0.3s ease;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    #cardNumber, #expiryDate, #cvvNumber, #cardName {
        font-size: 16px; /* Prevent zoom on iOS */
    }
}
</style>
{% endblock %}